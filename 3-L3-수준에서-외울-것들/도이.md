# 3. L3 수준에서 외울 것들

## IPv4의 구조
- IP 주소는 기본적으로, 32bit를 8bit씩 쪼갠 구조이다.
- 24bit만큼은 Network ID, 나머지 8bit는 Host ID이다. (서울시 강남구 역삼동 / ~번지 와 같이 정보가 나눠져 있다고 생각하면 된다.)

## IP Packet
- IP 프로토콜에서 쓰이는 단위 데이터.
- Header와 Payload로 나뉘며, 이는 상대적인 분류이다.
  - Header 정보에 항상 기본적으로 있는 것은 출발지, 목적지 정보이다.
- MTU(Maximum Transmission Unit): 패킷의 최대 크기 (통상 1500 byte)

## Encapsulation과 Decapsulation
- 마트료시카 인형을 떠올리면 된다!
  - L2 프레임의 페이로드 안에 L3 IP 패킷이 있고, 그 패킷의 페이로드 안에 L4 세그먼트 ... 
  - L4 -> L5에서부터는 Stream으로 통신하므로 해당되지 않음
  
## 패킷의 생성과 전달
  - 패킷의 생성과 전달은 택배로 비유할 수 있다.
  > "TCP 담당 부분은 접속, 송/수신, 연결 끊기의 각 단계에서 통신 상대와 대화할 때 IP 담당 부분에 의뢰하여 대화하는 데이터를 패킷의 모습으로 만들어 상대에게 도착한다"  
  <성공과 실패를 결정하는 1%의 네트워크 원리> 중..  
  책으로 정확한 학습 후 정리해서 공유하도록 하겠습니다.. ㅎㅎ


## 계층별 데이터 단위
  - L1 ~ L2: Kernel mode의 Driver <-> Frame
  - L3: Kernel mode의 IP 프로토콜 <-> Packet
  - L4: Kernel mode의 TCP 프로토콜 <-> Segment
  - L5 ~ L7: User mode의 Socket <-> Stream
    -  프로세스가 Socket을 이용해서 송수신한다.
    -  Stream의 특징
       - 시작은 있지만, 끝은 정확하게 정의할 수 없다. 어플리케이션 계층의 프로세스가 정하기 때문이다.
       - 운영체제 입장에서는 연속적으로 이어진, 크기를 알 수 없는 큰 데이터이다.
       - Stream이라는 연속적인 데이터를 Segment, Packet으로 분할시켜 보내는 것이다.
  
## TCP/IP 송,수신 구조
- 전체적인 흐름을 이해하기
- 입출력이 일어날 때에는, Socket에 부착된 Buffer가 있기 마련이다. (Buffered I/O)
- 송신하는 측에서는 Encapsulation이, 수신하는 쪽에서는 Decapsulation이 일어난다.
- 수신 측의 Socket에서 Buffer에 데이터를 받을 때에는 속도차가 발생한다. (?)
- 운영체제의 L4 계층에서 데이터를 잘 받았다고 피드백을 주는 것이 ACK
  - ex) 3번 데이터를 받았으면 ACK #3
- 송신 측에서는 보낸 데이터에 대한 ACK이 올 때까지 기다린 뒤 다음 데이터를 보낸다
- 이 과정에서 일어날 수 있는 대표적인 Network 수준의 장애
  1. Loss
     - 세그먼트 유실
  2. Re-transmission으로 인한 ACK 중복
     - ACK가 오랜 시간 오지 않으면 재전송)
  3. Out of Order
     - 데이터 순서가 맞지 않음
     - TCP에서 이를 보정해줌
  4. Zero Window 
     - 여유 공간을 window size라 한다.
     - 버퍼를 비워주는 처리 속도보다 송신 속도가 느려서 버퍼가 꽉 차면 발생한다. 

## IPv4 헤더 형식
- 두번 째 행은 단편화와 관련된 내용이다. (Identification, Flags, Fragment offset)
  - 네트워크 간 MTU의 차이가 있을 수 있다. 이럴 때 필요한 게 단편화이다.
- TTL(Time to Live): 데이터의 유효 기간. Hop 단위를 지날 때마다 감소한다.
- Protocol: L3 패킷의 페이로드 내에 또 다른 헤더가 있다면, 그 헤더가 어떤 것인지 알려준다.
- Header checksum: 검사 합을 이용해서 패킷의 손상 여부를 확인하는 값
- Source Address
- Destination Address
- Options
- Data