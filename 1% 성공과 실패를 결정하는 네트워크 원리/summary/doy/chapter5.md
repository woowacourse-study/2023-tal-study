# chapter 5 전체 정리

## 전체 흐름
패킷이 웹 서버에 도착할 때 웹 서버 측의 LAN에 도착 -> 방화벽 -> 캐시 서버 를 지나는 과정.

### 방화벽
- 서버의 설치 장소와 관계 없이, 패킷이 서버에 도착하기 전 방화벽을 두는 것이 일반적이다.
- 일반적으로 방화벽은 패킷 필터링형으로 패킷을 선별한다.
- 패킷 필터링형은 조건을 설정해 패킷을 통과시키거나 차단한다.
  - 패킷 헤더의 제어 정보를 조사해 조건을 설정한다.
  - 헤더 뿐만 아니라, ICMP 메시지의 내용도 조건 설정에 사용한다.
  - TCP/UDP 헤더에 기록된 포트 번호를 조건에 추가해 애플리케이션을 한정한다.
  - TCP의 경우 컨트롤 비트로 접속 방향을 판단해, 웹 서버 -> 인터넷 측의 잘못된 액세스를 정지시킬 수 있다.
  - 패킷 필터링형 방화벽은 주소 변환 기능도 가지고 있다.

### 리퀘스트를 분배한 서버의 부하 분산
- 분산 처리
  - 서버에 액세스가 증가할 때, 복수의 서버를 두어 부하를 분산할 수 있다.
  - DNS 서버에서 라운드 로빈 방식으로 요청을 균등하게 분배하는 것이 일반적이다.
  - 하지만 일부 서버가 고장났는지 확인하지 못한다는 단점이 있다.
- 로드 밸런서(부하 분산 장치)는 위 방식의 문제를 피하기 위해 고안되었다.
  - 웹 서버 대신 부하 분산 장치의 IP 주소를 DNS 서버에 등록한다.
  - 그러면 클라이언트는 부하 분산 장치에 웹 액세스하므로, 부하 분산 장치가 복수의 웹 서버에 요청을 분배한다.
  - 웹 서버 측에서는 매번 받은 요청에 대한 전후 관계를 알기 어렵다는 단점이 있다.
    - 이에 대해서는 헤더 필드에 관련 정보를 부가하는 해결 방법이 있다.

### 캐시 서버를 이용한 부하 분산
- 캐시 서버를 통해서도 분산 처리를 할 수 있다.
  - 캐시 서버는 프록시 구조를 사용하여 데이터를 캐시에 저장하는 서버이다.
  - 웹 서버와 클라이언트 사이에서, 액세스 동작을 중개하며 데이터를 캐시에 저장한다.
  - 변경되지 않는 정적 데이터를 캐시 서버에 관리할 수 있다.
- 캐시 서버의 동작
  - 데이터가 등록되지 않은 경우, `Via` 헤더를 추가해 웹서버에 요청 전송
  - 데이터가 등록된 경우, 데이터 변경 여부를 조사 
    - `If-Modified-Since` 헤더를 추가해 웹서버에 요청 전송
      - 데이터가 변경되었으면 새로 저장 후 응답, 변경되지 않았으면 그대로 응답
  - 이 과정에서 클라이언트에 응답할 때, 캐시 서버를 거쳤음을 나타내기 위해 `Via` 헤더를 추가한다.
- 위와 같은 방식은 보통 서버 측에 프록시를 둔다. 하지만 프록시 구조의 원형은 포워드 프록시이다.
  - 포워드 프록시 : 프록시에서 요청을 받고 인터넷에 전송한다. (브라우저 설정 화면에서 프록시 서버 항목에 IP 주소를 설정) `브라우저-프록시->웹서버`
  - 리버스 프록시 : 포워드 프록시는 브라우저에 대한 설정이 필요하기 때문에, 서버 측에 프록시를 둔다. `브라우저->프록시-웹서버`

### 콘텐츠 배포 서비스 (CDS)
- 인터넷에 다수의 캐시 서버를 설치하고, 웹 서버 운영자에게 대출하는 서비스
  - 클라이언트 측에 가까운 인터넷에 캐시 서버를 두는 것의 장점
    - 서버 측/클라이언트 측 LAN에 캐시 서버를 두는 것과 달리 인터넷 트래픽을 억제하는 동시에 웹 서버 운영자가 이를 제어할 수 있다.
  - 콘텐츠 배포 서비스를 이용하면 이를 쉽고 저렴하게 할 수 있다.
- 가장 가까운 캐시 서버에 액세스하는 법
  - DNS 서버에서 설정하기
    - 라우터의 경로표들을 입수하여 DNS까지의 대략적 거리를 계산한다.
  - 리피터용 서버로 액세스 대상 분배하기
    - 리다이렉트용 서버가, DSN 서버와 마찬가지로 라우터에서 모은 경로 정보로 가장 가까운 캐시 서버를 찾는다.
    - Location 헤더를 이용해 가장 가까운 캐시 서버로 리다이렉트시킨다.
  - 경로 정보를 사용하지 않고, 패킷의 왕복시간으로 거리를 계산하는 방법도 있다.