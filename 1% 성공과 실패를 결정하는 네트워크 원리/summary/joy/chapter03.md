#  Chapter 03 Summary

## 01. 케이블과 리피터, 허브 속을 신호가 흘러간다.

### 패킷은 독립적으로 동작한다.  
- 헤더에 기록된 제어정보와 중계장치 내부에 있는 중계 대상을 등록한 표로 목적지를 판단하고 중계한다.  
- 이 때, 중계장치는 데이터 부분을 보지 않고 패킷을 중계한다.  

### LAN 케이블은 신호를 약화시키지 않는 것이 핵심이다.  
- LAN 어댑터에서 패킷이 송신되어 케이블로 나간다. 
- LAN 어댑터의 PHY(MAU) 회로에서 패킷을 전기 신호로 바꾼다.
- RJ-45 커넥터를 통해 트위스트 페어 케이블에 들어간다.
- 전기 신호가 리피터 허브의 커넥터 부분에 도착한다.
  - 송출한 신호는 허브에 도착할 때는 신호가 약해지고, 왜곡된 파형을 가진다(잡음 존재 시 더 심각함).
  - 약해진 신호는 통신 오류의 원인이 된다.

### 꼼은 잡음을 방지하기 위한 방법이다(트위스트).
- 케이블 주위에 발생하는 전자기파로 인해 잡음이 생긴다.  
- 케이블에 영향을 받는 전자파는 2가지이며, 각각 케이블 외부 기기에서 누설되는 전자파와 케이블 안의 인접한 신호선에서 누설되는 전자파이다.  
- 신호선을 마주 꼼으로써 두 전자파의 영향을 최소화 할 수 있다.

## 02. 스위칭 허브의 패킷 중계 동작

### 스위칭 허브는 주소 테이블로 중계한다.
- 스위칭 허브는 이더넷의 패킷을 목적지로 중계한다.
- 스위칭 허브의 내부 구성
  - MAC 주소표: MAC 주소와 포트 번호를 등록한 테이블(수신 시 송신처 주소와 수신 포트 등록)
  - 스위치 회로: 패킷을 중계하는 핵심 부분. 입력 포트와 출력 포트를 연결할 수 있는 전자 회로
  - 포트: 스위칭 허브의 각 포트는 PC의 LAN 어댑터와 유사하지만, 수신처 MAC 주소를 검사하지 않고 모든 패킷을 수신 (MAC 주소가 할당X)

### 스위칭 허브의 동작
- MAC 주소표에서 MAC 주소를 조사하고, 해당하는 포트에서 신호를 송신
- LAN 어댑터와 거의 동일한 저장 과정
```
신호 - 커넥터 - PHY(MAU) 회로 (공통 신호 형식으로 변환) - MAC 회로(디지털 데이터로 변환) - FCS 대조(오류 검사) - 버퍼 메모리 저장  
```
-  수신처 MAC 주소가 MAC 주소표에 등록되어 있는 지 조사 - 송신 포트 판단
- 스위치 회로를 경유하여 송신측의 포트에 패킷을 보냄
- MAC 회로나 PHY(MAU) 회로가 송신 동작을 진행 - 소켓을 신호로 변환하여 송신 (다른 기기 신호 들어오면 재밍 신호 보냄)

### MAC 주소 테이블을 등록 및 갱신한다
- 스위칭 허브가 패킷을 중계할 때, MAC 주소표 내용의 갱신 동작도 같이 실행
- 스위칭 허브는 MAC 주소표의 내용을 스스로 등록 및 삭제하므로, 수동 관리가 필요 없다.  


### 예외적인 동작
- 패킷을 수신한 포트와 송신한 포트가 같은 경우: 패킷 폐기
- MAC 주소표에 수신처 MAC 주소와 일치하는 주소가 없는 경우: 수신 포트 이외 전체 포트에서 패킷 송신

### 전이중 모드에서 송신과 수신을 동시에 실행한다
- 전이중 모드
  - 송신과 수신을 동시에 실행할 수 있는 동작 모드
  - 스위칭 허브의 특징

- 송수신 분리
  - 송신, 수신 신호 분리하면 충돌 X
  - 트위스트 페어 케이블 선은 송신용과 수신용으로 구분
  - 스위칭 허브 포트, LAN 어댑터 회로와 MAC 회로도 송신과 수신 구분

- 이더넷과 전이중 모드
  - 신호가 흐르고 있으면, 끝나길 기다렸다가 송신 동작을 실행 (이더넷 규칙)
  - 전이중 모드에서는 신호가 흘러도 송신하며, 충돌을 검출하는 회로 무효화
  -  전이중 모드는 반이중 모드보다 빠르고, 성능이 좋다.

### 최적의 전송 속도로 보내는 자동 조정
- 자동 조정 기능: 동작 모드(전이중 모드와 반이중 모드)를 자동으로 전환, 전송 속도를 자동으로 전환
- 이더넷은 데이터가 흐르지 않을 때 링크 펄스라는 펄스형의 신호 흘리며, 자동 조정 기능은 이 펄스 신호를 특정 패턴으로 송신하는 방식을 이용

## 03. 라우터의 패킷 중계 동작
- 스위칭 허브를 경유한 패킷은 라우터에 도착한다.
- 라우터는 IP 주소를 바탕으로 패킷을 중계한다.

### 라우터
> 라우터는 중계 부분과 포트 부분으로 구성되어 있다.
- 포트 부분(대상 판단): 패킷을 수신하는데, 포트 부분의 통신 기술 규칙에 따라 동작이 다르다.
- 중계 부분(송수신): 헤더에 등록된 수신처 IP 주소와 중계 대상을 등록한 표를 기준으로 대상을 판단한다.
- 라우팅 테이블
  - 수신처 : 서브넷 자체를 나타내는 주소
  - 넷마스크: 어디까지가 네트워크 번호 부분인지 판단하기 위함
  - 게이트웨이: 패킷의 중계 대상의 IP 주소
  - 인터페이스(포트): 라우터에서 인터페이스란 말과 포트란 말은 같은 의미
  - 메트릭: 기록된 목적지와의 거리

### 라우터의 패킷 수신 동작
- MAC 헤더의 수신처 MAC 주소가 자신에게 해당하면 패킷을 수신 버퍼 메모리에 저장, 아니면 폐기한다.
- 패킷 수신 동작 후 MAC 헤더 폐기
- IP 헤더의 내용을 보고 패킷 중계 동작에 진행
- 중계표에 해당하는 경로가 없다면 패킷을 폐기하고, 송신처에 이 사실을 통지한다. (ICMP 프로토콜 이용)
- 하지만 기본 게이트웨이 설정으로 이런 문제를 방지할 수 있다.

### 송신 전의 일들
- 패킷 유효기간
  - 중계대상을 찾은 패킷을 출력 측의 포트로 옮기고 송신한다. 
  - 그 전에, IP 헤더의 필드인 TTL(생존 기간)을 갱신한다.

- 큰 패킷 조각 나누기
  - 출력 포트측의 최대 길이, 출력측의 패킷 최대 길이 등으로 차 가 생기면 IP 프로토콜에 규정된 조각 나누기 방법을 사용해 패킷을 쪼갠다.  
  - 출력측의 MTU를 조사한다.
  - 출력측의 MTU가 작은 경우에는, IP 헤더의 플래그 필드를 조사하여 분할해도 좋을지 확인한다. 
  - 플래그 필드가 분할 불가로 되어있으면 패킷을 폐기하고, 송신처에 통지한다. 
  - TCP 헤더도 데이터로 간주해서 TCP 헤더 이후의 부분을 잘라서 분할하고, IP 헤더를 덧붙인다.

### 라우터의 송신 동작
> 송신 동작은 출력측의 포트에 따라 다르다.  

- 이더넷은 패킷의 맨 앞 부분에 MAC 헤더를 부가하고, 패킷을 완성해 전기신호로 변환한다.
- 수신처 MAC 주소 필드에 패킷을 받을 상대의 MAC 주소를 설정한다.
- 경로표를 보고 건네줄 상대를 찾기
  - 게이트웨이 항목에 IP 주소가 쓰여있으면 이 IP 주소가 건네줄 상대이다. 
  - 게이트웨이 항목이 공란이면, IP 헤더의 수신처 IP 주소가 건네줄 상대이다.
- 상대의 IP 주소가 결정되면 ARP로 MAC 주소를 조사한다.
- 송신처의 MAC 주소로는 출력 측의 포트에 할당된 MAC 주소를 설정한다.
- 이 패킷은 이제 MAC 주소를 가지고 있으므로 스위칭 허브를 경유하여 다음 라우터에 도달할 수 있다

## 04. 라우터의 부가 기능
> 라우터의 부가 기능으로는 주소 변환과 패킷 필터링 기능이 있다.  

### 주소 변환으로 IP 주소를 효율적으로 이용한다.
- 사내 네트워크를 인터넷에 접속할 때, 사내의 네트워크를 인터넷에 공개하는 서버를 접속하는 부분과 사내용 네트워크의 두 가지로 나눈다.
- 공개용 서버쪽에는 글로벌 주소를 할당해서 인터넷과 직접 통신한다.
- 사내 네트워크에서는 특별한 구조를 사용하여 접속한다 (주소 변환).

### 주소 변환의 기본 동작
> 주소 변환: 패킷을 중계할 때 IP 헤더에 기재된 IP 주소와 포트번호를 바꿔쓰는 것 

- 패킷의 송신처 IP 주소를 프라이비트 주소에서 글로벌 주소로 바꿔 쓴다.
- 글로벌 주소는 주소 변환 장치의 인터넷측에 있는 포트에 할당된 주소이고, 포트 번호도 바꿔 쓴다.
- 글로벌 주소, 포트 번호를 세트로 주소 변환 장치 내부 대응표에 기록함(통신 이후 제거)
  - 포트 번호도 함께 사용하지 않고 주소만 바꿔쓴다면 프라이비트 주소와 글로벌 주소가 1:1로 대응해서 인터넷에 접속하는 대수만큼 글로벌 주소가 필요
  - 글로벌 주소의 이용 효율을 높일 수 있음

### 라우터의 패킷 필터링 기능
- 패킷을 중계할 때 MAC 헤더, IP 헤더, TCP 헤더에 기록되어 있는 내용을 조사하여 그것이 사전에 설정한 조건에 합치되면 패킷을 중계하거나 폐기하는 동작을 실행한다.
- 대부분의 방화벽이라는 기기나 소프트웨어는 이 원리를 이용하여 부정 침입을 방지한다.
