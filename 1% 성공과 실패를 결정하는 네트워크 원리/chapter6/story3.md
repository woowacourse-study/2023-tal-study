# Story 3. 웹 서버 소프트웨어가 리퀘스트 메시지의 의미를 해석하여 요구에 응한다.  

## 1. 조회의 URI를 실제 파일명으로 변환하다.  
> 웹 서버는 `read`에서 받은 내용이 `HTTP 리퀘스트 메시지`가 된다.  
> 리퀘스트 메시지에 따라 적절한 처리를 하여 응답 메시지를 만들고 `write`를 통해 클라이언트에 반송한다.  

리퀘스트 메시지의 메소드나 URI에 따라 웹 서버의 내부 동작은 달라진다.  
- `메소드`는 일종의 명령 
- `URI`은 데이터 출처
- `내용`에 따라 데이터를 클라이언트에 반송

<br><br>

### URI로 파일 읽기
> 단순히 URI에 기록된 파일을 읽는다면, 웹 서버의 디스크가 무방비 상태로 노출되어 위험할 수 있다.  

웹 서버는 실제 디렉토리가 아닌 **가상으로 만든 디렉토리**를 공개한다.  
즉, 가상의 디렉토리 구조에서의 경로명을 URI에 써야 한다.  

아래는 그 예시다.  

```
1. 실제 디렉터리 구조
/home/user/sub/index.html

2. 가상 디렉터리 구조
/sub/index.html

3. 변환
/sub/index.html -> /home/user/sub/index.html
```

그렇기 때문에 웹 서버는 파일을 읽어올 때 아래와 같이 동작한다.  
- 가상 디렉토리와 실제 디렉토리 대응 관계 조사
- 실제 디렉토리의 경로명으로 변환
- 파일을 읽어 데이터 반송

<br><br>

### URI에 파일명이 생략된 경우
> URI에 파일명이 생략된 경우 미리 설정한 파일이 있다고 간주한다.  

```text
1. 요청 URI
/home/user/sub/

2. 변환
/home/user/sub/index.html
```

이 밖에도 파일명을 바꿔쓰는 규칙을 서버에서 설정하고 액세스하는 경우도 있다.  



<br><br><br><br>

## 2. CGI 프로그램을 작동하는 경우
> 프로그램 파일의 이름을 URI에 쓸 수도 있다. 
> 이 경우 프로그램을 작동 시켜서 프로그램이 출력하는 데이터를 반송한다.  
> 웹 서버에서 작동 시키는 프로그램은 다양하며, 우리는 CGI(Common Gateway Interface) 프로그램 동작에 대해 알아본다.  

이 경우 브라우저는 어떤 데이터를 리퀘스트 메시지 안에 넣어 전송한다.  
`GET` 일 때는 URI 뒤에 입력 데이터를 내장해 서버로 보낸다.  
`POST` 일 때는 HTTP 리퀘스트 메시지의 메시지 본문에 데이터를 내장해 서버로 보낸다.  

```text
1. 메소드가 GET 일 때
GET /cgi/sample.cgi?Field1=ABC&Field2=EFG HTTP/1.1

2. 메소드가 POST 일 때
POST /cgi/sample.cgi HTTP/1.1
Field1=ABC&Field2=EFG
```

<br><br>

### 웹 서버의 동작
- URI 내 파일명을 조사하여 프로그램인지 판단한다 
  - `.cgi`, `.php` 등의 등록된 확장자인지 확인
  - 일치하면 프로그램으로 간주한다.
  - 프로그램용 디렉토리명을 설정해두고 해당 디렉토리 파일을 프로그램으로 간주할수도 있음
- 웹 서버는 OS에 프로그램 작동을 의뢰
- 리퀘스트 메시지의 데이터를 추출하여 프로그램에 전달
  - `GET` 메소드면 URI에서 추출
  - `POST` 메소드면 본문에서 추출
- 프로그램이 데이터를 처리하여 웹 서버에 돌려줌
  - 출력 데이터의 내용은 프로그램에 따라 달라서 웹 서버는 알 수 없음 (관여 X)
- 웹 서버는 이 것을 클라이언트에 반송함


<br><br><br><br>

## 3. 웹 서버로 수행하는 액세스 제어 
> 웹 서버의 기본 동작: 레퀘스트 메시지의 내용에서 데이터 출처 판단, 클라이언트에 데이터 반송
> 동작 실행 시 액세스 제어가 가능하다.  

- 액세스 제어: 조건에 따라 동작 여부를 설정하는 기능
  - 사전에 설정해 둔 조건에 해당하는지 조사
  - 조건에 따라 동작 여부 결정

- 회원제 정보 제공 서비스 등과 같이 특정 사용자에게 액세스를 허가하는 경우 사용  

<br><br>


### 액세스 제어 조건
> 웹 서버에 설정하는 주요 조건 3가지

- 클라이언트 주소
- 클라이언트 도메인명
- 사용자명과 패스워드

이 조건을 데이터 출처와 대응해서 설정한다.  
URI에서 데이터 출처 판단 후 액세스 가능 여부 조건이 설정되어 있는지 조사하고, 허가된 경우 작동한다 (파일 읽기 또는 프로그램 실행)  

<br><br>


### 액세스 제어 - 클라이언트 주소
> `accept`로 접속을 접수했을 때, 클라이어트 IP 주소를 점검한다.  

<br><br>


### 액세스 제어 - 클라이언트 도메인명
> 클라이언트 IP 주소에서 도메인 명을 조사한다(DNS 서버 이용). 
> 이 방법은 DNS 서버의 조회 메시지가 왕래하는 만큼 시간이 걸리고, 웹 서버 응답시간이 길어진다.  

- 클라이언트에서 리퀘스트 메시지를 보낸다.  
- 웹 서버는 프로토콜 스택에 의뢰
  - 패킷의 송신처 IP를 조사
  - IP 주소에 대응하는 이름을 조회하는 메시지를 만들어 가까운 DNS 서버에 보냄
- DNS 서버는 IP 주소가 등록된 DNS 서버를 찾아 조회 요청
- 도메인명이 회답으로 돌아오면 웹 서버측 DNS 서버가 웹 서버에 전송
- 도메인명에서 IP주소를 조사한 후 송신처 IP와 일치하는지 확인
  - 도메인명을 위조하여 DNS 서버에 등록하는 공격 방지를 위해 이중 점검
- 도메인명을 설정한 조건을 대조하여 액세스할 수 있는지 판단

<br><br>


### 액세스 제어 - 사용자명과 패스워드
- 웹 서버가 사용자명과 패스워드를 기록하거나 리퀘스트 메시지를 보내도록 응답 메시지에서 클라이언트에 통지  
- 브라우저가 사용자명과 패스워드를 입력하는 화면 표시
- 사용자가 사용자명과 패스워드 입력
- 리퀘스트 메시지를 통해 웹 서버에 통지
- 웹 서버는 사용자명과 패스워드를 사전 설정 값과 대조하여 액세스 가능 여부 판단



<br><br><br><br>

## 4. 응답 메시지를 되돌려 보낸다  
> 리퀘스트 메시지에 대해 처리가 끝나면 응답 메시지를 발송한다.  

- 웹 서버가 Socket 라이브러리의 write 호출하여 응답 메시지를 프로토콜 스택에 전달
  - 응답 메시지를 보낼 곳을 알려줘야 함
  - 어느 소켓을 사용하여 통신 하고 있는지를 나타내는 디스크립터를 통지하여 상대 지정
  - 소켓에 통신 상대 정보가 기록되어 있어서 디스크립터만 통지해도 된다. 
- 프로토콜 스택은 데이터를 패킷에 들어가는 길이로 분할하고 헤더를 붙여 패킷을 송출함
- 패킷은 스위치, 라우터 등을 경유하여 클라이언트에게 도착
- 
