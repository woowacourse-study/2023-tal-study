# story 4.서버에서 연결을 끊어 소켓을 말소한다.

## 1. 데이터 보내기를 완료했을 때 연결을 끊는다.
> 데이터 송수신 동작이 끝난 후 프로토콜 스택의 움직임을 알아본다.  
>  ✔︎ 본 글에서 드는 예시는 HTTP 1.0 프로토콜을 사용한 경우입니다.    

애플리케이션이 송신해야 하는 데이터를 전부 송신 완료했다고 판단하면 데이터 송수신을 종료한다.  
- 송신을 완료한 측은 연결 끊기 단계로 들어간다.  
- 어디에서 데이터 송수신 동작이 끝나는지는 애플리케이션에 따라 다르다.


서버측에서 연결 끊기 단계에 들어간다고 생각해보자.  

### 서버측
- `애플리케이션`이 먼저 `Socket 라이브러리`의 `close`를 호출한다.
- `프로토콜 스택`이 `TCP 헤더`를 만들고, 연결 끊기를 나타내는 정보를 설정한다.
- 컨트롤 비트의 `FIN 비트에 1을 설정`하고, `IP 담당 부분`에 의뢰하여 클라이언트에 송신해달라고 한다.
- 소켓에 연결 끊기 동작에 들어갔다는 정보를 기록한다.

### 클라이언트측
- 서버에서 FIN에 1을 설정한 TCP 헤더가 도착하면, 클라이언트측의 `프로토콜 스택`은 자신의 소켓에 서버측이 연결 끊기 동작에 들어갔다는 것을 기록한다.  
- 패킷을 받은 사실을 알리기 위해 `ACK 번호`를 서버측에 반송하고, 이 것이 끝나면 `애플리케이션`이 데이터를 가지러 올 때까지 기다린다.
- `애플리케이션`이 `read`를 호출하여 데이터를 가지러온다.
- 데이터를 건네지 않고, 서버에서 보낸 데이터를 전부 수신 완료했다는 사실을 클라이언트측의 애플리케이션에게 알린다.  
  (이전에 수신한 데이터가 수신 버퍼에 남아있으면 애플리케이션에 전달)  
- 웹의 동작은 서버가 응답을 반송하면 끝나도록 규칙으로 정해져 있으므로 서버에서 보낸 데이터를 전부 수신 완료하면 클라이언트도 종료한다.
- 애플리케이션이 close를 호출하여 데이터 송수신 동작을 끝낸다.  
- 프로토콜 스택은 FIN 비트에 1을 설정한 TCP 헤더를 만들고 IP 담당부분에 의뢰해서 서버에 송신한 후 서버에서 ACK 번호가 돌아오면 서버와의 대화가 끝난다.  

## 2. 소켓을 말소한다.  
> 서버와의 대화가 끝나면 소켓은 필요 없지만, 오작동을 막기 위해 잠시 기다린 후 소켓을 말소한다.  

* 발생할 수 있는 오작동의 예
  * 클라이언트가 FIN 송신
  * 서버가 ACK 번호 송신
  * 서버가 FIN 송신
  * 클라이언트가 ACK 번호 송신
  * 이 때, 서버가 ACK 번호가 다시 돌아오지 않아 FIN을 다시 보낼 수도 있다. 
  * 그런데 클라이언트의 socket이 말소 되었을 수 있고, 그렇게 되면 제어 정보와 할당된 포트 번호도 알 수 없게 된다.  
  * 만약 다른 애플리케이션이 새 소켓에 같은 포트 번호를 할당받는다면, 새 소켓에 FIN이 도착할 것이다.  
  * 그럼 소켓은 연결 끊기 동작에 들어갈 것이다.

패킷이 없어졌을 때, 다시 보내기 동작은 몇 분동안 계속 된다. 이후에는 회복이 불가하다 판단하여 다시 보내기 동작을 멈춘다.  


## 3. 데이터 송수신 동작을 정리한다.  
> 데이터 송수신 동작 전체를 정리해보자.  

### 접속  
> 데이터 송수신에서 최초의 동작은 소켓을 작성하는 단계이다.  
* 서버측에서 애플리케이션이 동작하기 시작했을 때 소켓을 만들고, 접속 대기 상태로 만든다. 
* 소켓 작성 단계에서는 패킷이 흐르지 않는다.  
* 소켓을 만들면 클라이언트에서 서버를 향해 접속 동작을 살행한다(사용자가 동작하면 패킷 생성).
  * 클라이언트가 SYN을 1로 만든 TCP 헤더를 만들어서 서버로 보낸다.  
  (클라이언트가 서버에 데이터를 보낼 때 사용하는 시퀀스 번호의 초기값도 기록)
  * 서버에서 클라이언트에 데이터를 송신할 때 사용하는 윈도우 값도 기록되어 있음
* 이게 서버에 도착하면 서버에서 SYN을 1로 만든 TCP 헤더(시퀀스 번호, 윈도우, ACK 번호 기록)가 돌아온다.
* 클라이언트에서 서버로 ACK번호를 기록한 TCP헤더를 보낸다.

### 송수신

* 웹의 경우 클라이언트에서 서버에 리퀘스트 메시지를 보내는 것부터 시작한다.
* TCP는 이 것을 분할하고 TCP 헤더를 맨 앞에 부가해서 서버에 보낸다.  
  * TCP 헤더에는 시퀀스 번호(송신 데이터가 몇 번째 바이트부터 시작되는지 나타냄)가 기록되어 있다.
* 서버는 ACK 번호를 반송한다.
* 최초의 데이터라면 서버는 받기만 하고, 이후에는 애플리케이션에 데이터를 넘긴다.
  * 이 때, 수신 버퍼에 빈 영역이 생기고, 이 때 윈도우 값을 기록하여 클라이언트에 통지한다.  
* 이렇게 클라이언트에서 서버에 리퀘스트 메시지를 보내면 서버는 응답 메세지를 반송할 것이다.

### 연결 끊기
* 서버가 응답 메세지를 보내기를 완료하면 연결 끊기 동작에 들어간다.  
  (웹의 경우 서버에서 먼저 연결 끝기 동작에 들어감)  
* FIN을 1로 만든 TCP 헤더가 흐르고, ACK 번호의 TCP 헤더가 돌아온다.  
* 역방향으로 FIN을 1로 만든 TCP 헤더와 ACK 번호의 TCP 헤더가 흐른다.  
* 잠시 후 소켓이 말소된다.







