# story3. 전 세계의 DNS 서버가 연대한다.

## 1. DNS 서버의 기본 동작

> 클라이언트에서 조회 메세지를 받고, 조회의 내용에 응답하는 형태로 정보를 회답하는 일.

### 조회 메세지

조회 메세지는 다음 세 가지 정보를 포함하고, 이 세 가지 정보에 대응하는 정보를 찾아 클라이언트에 회답한다.  

타입을 구분해서 사용해야하므로 다양한 정보를 취급할 수 있다.  

- 이름: 서버 또는 메일의 목적지(`@주소` 부분)의 이름  
- 클래스: 식별하기 위해 클래스라는 정보를 사용했으나, 현재는 인터넷 이외의 네트워크는 소멸되어 인터넷을 의미하는 `IN` 값만 사용한다.  
- 타입: 이름에 어떤 타입의 정보가 지원되는지를 나타낸다.  
    - `A` , `MX` 등이 있으며, 타입에 따라 클라이언트에 회답하는 정보의 내용도 달라진다.  
    - `A` (Address): IP 주소를 조회할 때 사용  
    - `MX` (Mail eXchange): 메일 배송 목적지를 조회할 때 사용.  

<br><br><br><br>

### 리소스 레코드

DNS 서버에서 1건 분의 등록 정보를 `리소스 레코드` 라고 한다.  

아래 표의 행 하나를 그 예로 생각해 볼 수 있다.  

| 이름 | 클래스 | 타입 | 회답 항목 |
| --- | --- | --- | --- |
| www.lab.cyber.co.kr | IN | A | 192.0.2.226 |

<br><br><br><br>

### 참고 사항  

- 모든 웹 서버가 `www` 로 시작해야하는 것은 아니다. 관례일 뿐이며, 원하는 이름을 사용하고 DNS 서버에 `A`  타입으로 등록하면 웹 서버의 이름으로 사용할 수 있다.  
- `MX` 타입일 경우, 메일 서버의 `우선 순위`와 `메일 서버의 이름` 을 회답한다. 이에 더해 메일 서버의 IP 주소도 함께 회답한다.  
    - 클라이언트 회답 항목에 `우선 순위`와 `메일 서버의 이름` 를 모두 등록해둔다.  
    - `우선 순위` 가 있는 이유는 메일 배송 목적지로 복수의 메일 서버가 등록되어 있을 때 어느 메일 서버를 우선 선택해야 하는지를 판단하기 위함이다. 작은 값으로 등록되어 있는 메일 서버를 우선한다.  
- 타입의 종류로는 `A` , `MX`  이외에도 여러 타입이 존재한다.  
    - `PTR` : IP 주소에서 이름을 조사할 때 사용  
    - `CNAME` : 이름에 닉네임을 붙이기 위해 사용  
    - `NS` : DNS 서버의 IP 주소를 등록  
    - `SOA`: 도메인 자체 속성 정보 등록  

<br><br><br><br>

## 2. 도메인의 계층

> 사내 네트워크처럼 웹 서버나 메일 서버의 수가 제한되어 있으면, 한 대의 DNS 서버에 등록할 수 있으므로 DNS 서버에 이미 정보가 등록되어 있을 수 있다.  
하지만 인터넷에는 많은 수의 서버가 있으므로 한 대의 DNS 서버만을 사용하는 것은 불가능하다.  
그렇기 때문에 **정보를 분산시켜서 다수의 DNS 서버에 등록하고, 다수의 DNS 서버가 연대하여 어디에 정보가 등록되어 있는지를 찾아내는 구조**를 이룬다.  
>


### 도메인

`www.lab.cyber.co.kr` 처럼 `.` 으로 계층을 구분하며, 구분된 하나하나를 **도메인**이라고 한다.  

(`.` 을 사용하면 계층을 간단히 늘릴 수 있기 때문에 유연성이 좋다)  

계층화된 도메인의 정보를 서버에 등록할 때, 하나의 도메인을 일괄적으로 취급한다.  

한 대의 DNS 서버에 복수 도메인의 정보를 등록할 수 있다.  
 
도메인 아래에 하위 도메인을 생성할 수 있는데, 이를 **서브 도메인**이라고 한다.  

- 예시  
    - 메인 도메인: `example.co.kr`  
    - 서브 도메인: `sub.example.co.kr`  

<br><br><br><br>

## 3. 담당 DNS 서버를 찾아 IP 주소를 가져온다.  

### 웹 서버가 등록된 DNS 서버를 찾는다.

먼저 하위의 도메인을 담당하는 DNS 서버의 IP 주소를 그 상위의 DNS 서버에 등록합니다.  

상위의 DNS 서버를 또 그 상위의 DNS 서버에 등록하는 식으로 차례대로 등록합니다.  

아래는 그 예입니다.  

- `com` 도메인의 DNS 서버
    - `glasscom.com` 의 DNS 서버 도메인을 등록
- `glasscom.com` 의 DNS 서버
    - `lab.glasscom.com` 의 DNS 서버 도메인을 등록

<br><br><br><br>

### 최상위 도메인과 루트 도메인

`www.naver.com.`

- `com` 이 최상위 도메인  
- 루트 도메인은 최상위 도메인의 상위 개념으로, 일반적으로는 생략한다. 끝에 마침표를 찍어서 나타낼 수 있다.  
- 루트 도메인의 DNS 서버를 인터넷에 존재하는 DNS 서버에 전부 등록하여 모든 DNS 서버가 루트 도메인에 액세스 할 수 있게 한다.  
- 루트 도메인의 DNS 서버에 할당된 IP 주소는 전 세계에 13개 밖에 없고, 잘 변경되지 않는다.  
- DNS 서버 소프트웨어를 설치하면 자동으로 루트 도메인의 DNS 서버 정보가 등록된다.  

<br><br><br><br>

### DNS 서버 찾기

- 클라이언트의 가장 가까이에 있는 DNS 서버에 웹 서버(`www.naver.com`)에 관한 정보를 조회한다.  

  (클라이언트의 TCP/IP 설정 항목의 DNS 서버로 설정되어 있는 DNS 서버)  

- 가장 가까운 DNS 서버(이하 A 서버)에 `www.naver.com` 가 등록되어 있지 않으면, A 서버가 루트 도메인 DNS 서버에 조회메세지를 전송한다.
- 루트 도메인 DNS 서버에 `com` 가 등록되어 있으므로  `com` 의 DNS 서버 IP 주소를 반송한다.
- `naver.com` 에서도 같은 과정을 반복한다.
- `www` 에 도달하면 클라이언트에 회답할 항목을 받는다.

참고 사항: 현실에서는 한 대의 DNS 서버에 복수 도메인의 정보를 등록할 수 있다. 그렇기 때문에 상위와 하위의 도메인을 같은 DNS 서버에 등록하는 경우도 있다.  

<br><br><br><br>

## 4. DNS 서버는 캐시 기능으로 빠르게 회답할 수 있다.

DNS 서버는 한 번 조사한 이름을 캐시에 기록한다. 조회한 이름이 도메인에 등록되어 있지 않은 경우에는 이름이 존재하지 않는다는 회답이 돌아오지만, 이 역시 캐시에 기록할 수 있다.  

캐시에 정보를 저장한 후 등록 정보가 변경되는 경우도 있기 때문에 주의 해야한다. 그렇기 때문에 DNS 등록하는 정보에는 유효기한을 설정하고, 지나면 캐시에서 삭제한다.  

조회에 회답할 때, 정보가 캐시에 저장된 것인지 등록처 DNS 서버에서 회답한 것인지 알려준다.  

- 캐시: 한 번 사용한 데이터를 데이터의 이용 장소와 가까운 곳에 잇는 고속의 기억 장치에 저장하여 두 번째 이후의 이용을 고속화하는 기술  
